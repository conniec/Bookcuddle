= content_for :head do
  :javascript
    function doAjax() {
      console.log('overrode');

      $('tr').each(
        function() {
          var that = $(this);
          var book_id = that.data('book_id');
          var friend_id = that.data('friend_id');
          var url = '/discussions/' + book_id + '?friend_id=' + friend_id;
          console.log(url);
          $.ajax({ url: url, 
                  type: 'GET',
                  dataType: 'json',
                  cache: false,
                  success: function(data) {
                    // If user data is returned
                    if (data['discussion_id'] != null) {
                      // select all the Invites and change to Compare

                      //get the td
                      var td = that[0];
                      //get the Invite tr
                      var tr = $(td).find('td[class=discussion]')[0];
                      //get the Invite a
                      var tr_a = $(tr).find('a');
                      //change the link HTML to 'Compare'
                      tr_a.html('View Discussion');
                      //change the link
                      var compare_link = '/compare/' + data['discussion_id'];
                      tr_a.attr('href', compare_link);
                    }
                  }
                }
          );
        });
    };

    $(document).ajaxStop($.unblockUI);

    $(document).ready( function() {
      $.blockUI({message: $('#domMessage')});
      doAjax();
    });

%h1 Unread Books

%table.table.table-striped
  %tr
    %td Title
    %td Your status
    %td Friend status
    %td 
  - @comparison.each do |book|
    %tr{:data => {:book_id => book[:id], :friend_id => @friend_goodreads_id } }  
      %td
        = link_to book[:title], book[:url]
      %td
        = book[:your_review]
      %td
        = book[:their_review]
      %td.discussion
        = link_to "Start Discussion", discussions_path({:book_id => book[:id], :user_2 => @friend_goodreads_id, :user_1 => @current_user.goodreads_id}), :method => :post

%div#domMessage{:style => 'display:none;'}
  %h1 Please wait...
  %div.progress.progress-striped{:style => 'width:60%;align:middle;'}
    %div.bar{:style => "width: 60%;"}